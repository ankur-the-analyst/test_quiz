<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proctored Business & Finance Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom styles to ensure full-screen on modern browsers */
        #app {
            min-height: 100vh;
        }
        /* Style for the leader board button, always visible */
        #adminButton {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
        }
        /* Custom progress bar styles */
        #progressBarContainer {
            position: relative;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        #progressBar {
            height: 100%;
            width: 100%; /* Start full */
            background-color: #ef4444; /* Red color for timer */
            transition: none; /* Removed transition for smooth timer animation */
        }
        #countdownTimer {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #ef4444; /* Red color */
            text-align: right;
            margin-bottom: 10px;
        }
    </style>
</head>
<body class="bg-gray-50">

    <button id="adminButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out text-sm">
        <i class="fas fa-lock mr-2"></i>Admin Panel
    </button>

    <div id="app" class="flex items-center justify-center p-4">
    </div>

    <div id="violationModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-900 mb-3">Exam Violation Detected!</h3>
            <p id="violationMessage" class="text-gray-600 mb-6 text-sm"></p>
            <button id="modalConfirmBtn" class="w-full py-2 px-4 rounded-lg text-white font-semibold bg-yellow-600 hover:bg-yellow-700 transition">
                I Understand
            </button>
        </div>
    </div>
    
    <div id="quizOffModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
            <i class="fas fa-pause-circle text-4xl text-blue-500 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-900 mb-3">Quiz is Currently Unavailable</h3>
            <p id="quizOffMessage" class="text-gray-600 mb-6 text-sm">The examination is currently paused or closed by the administrator. Please try again later.</p>
            <button id="quizOffConfirmBtn" class="w-full py-2 px-4 rounded-lg text-white font-semibold bg-blue-600 hover:bg-blue-700 transition">
                Close
            </button>
        </div>
    </div>
    
    <script>
        // --- SUPABASE CONFIGURATION ---
        // !!! IMPORTANT: REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL SUPABASE PROJECT DETAILS !!!
        // FIX: The condition check that prevents upload is removed, but you MUST replace these with YOUR credentials.
        const SUPABASE_URL = 'https://tdxausibwaagbhnbgkgz.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkeGF1c2lid2FhZ2JobmJna2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDgyMDYsImV4cCI6MjA3ODYyNDIwNn0.ApeJFTg-pQaV2gigOUTGpKnMY_AFnT1v5DPpYCCmOKY';
        const SUPABASE_TABLE_NAME = 'public.quiz_submissions'; 

        // Initialize Supabase client
        const { createClient } = supabase;
        const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // ------------------------------

        // --- QUIZ DATA ---
        const quizQuestions = [
            { question: "Who is the CEO of Apple Inc.?", options: ["Steve Jobs", "Tim Cook", "Mark Zuckerberg", "Elon Musk"], answer: "Tim Cook" },
            { question: "Who is the CEO of HDFC Bank (as of 2025)?", options: ["Aditya Puri", "Sashidhar Jagdishan", "N. Chandrasekaran", "Shailesh Chandra"], answer: "Sashidhar Jagdishan" },
            { question: "Who is the CEO of Tata Sons?", options: ["N. Chandrasekaran", "Ratan Tata", "Cyrus Mistry", "Noel Tata"], answer: "N. Chandrasekaran" },
            { question: "What does IPO stand for?", options: ["Initial Public Offering", "International Product Order", "Industrial Policy Objective", "Internal Purchase Option"], answer: "Initial Public Offering" },
            { question: "What does KPI stand for?", options: ["Key Performance Indicator", "Knowledge Processing Index", "Key Product Inventory", "Known Profit Index"], answer: "Key Performance Indicator" },
            { question: "What is a blue-chip company?", options: ["Large, established, financially sound firm", "New startup", "Government enterprise", "Small-cap company"], answer: "Large, established, financially sound firm" },
            { question: "The 2025 Union Budget of India was presented on", options: ["1 January 2025", "1 February 2025", "1 March 2025", "1 April 2025"], answer: "1 March 2025" },
            { question: "The term “start-up unicorn” refers to a private company valued at:", options: ["Over US $100 million", "Over US $1 billion", "Over US $500 million", "Over US $10 billion"], answer: "Over US $1 billion" },
            { question: "The program “PLI scheme” in India is related to:", options: ["Private Lending Initiative", "Production Linked Incentive", "Public Listing Initiative", "Pension Linked Interest"], answer: "Production Linked Incentive" },
            { question: "The parent company of Tanishq is:", options: ["Titan", "Reliance", "Aditya Birla Group", "Dabur"], answer: "Titan" },
            { question: "“Think Different” is associated with:", options: ["Apple", "Microsoft", "Samsung", "Dell"], answer: "Apple" },
            { question: "SEBI regulates:", options: ["Stock Market in India", "Banking Sector", "Insurance Companies", "E-commerce"], answer: "Stock Market in India" },
            { question: "“The Big Four” accounting firms include all except:", options: ["Deloitte", "PwC", "EY", "KPMG India Limited"], answer: "KPMG India Limited" },
            { question: "Which is the largest public sector bank in India?", options: ["State Bank of India", "Punjab National Bank", "Bank of Baroda", "Canara Bank"], answer: "State Bank of India" },
            { question: "Who is the current Governor of RBI (2025)?", options: ["Shaktikanta Das", "Urjit Patel", "Raghuram Rajan", "D. Subbarao"], answer: "Shaktikanta Das" },
            { question: "SBI’s tagline is:", options: ["“The Banker to Every Indian”", "“We Understand Your World”", "“Trusted Family Bank”", "“Your Perfect Partner”"], answer: "“The Banker to Every Indian”" },
            { question: "The first Indian bank to open a branch outside India was:", options: ["Bank of India", "SBI", "PNB", "Canara Bank"], answer: "Bank of India" },
            { question: "Which startup is known as “India’s leading edtech company”?", options: ["BYJU’S", "Unacademy", "Vedantu", "Simplilearn"], answer: "BYJU’S" },
            { question: "Which company became India’s first to cross $250 billion market cap?", options: ["Reliance Industries", "Tata Consultancy Services", "Infosys", "HDFC Bank"], answer: "Reliance Industries" },
            { question: "Which Indian bank ranked highest in “World’s Best Banks 2024” by Forbes?", options: ["HDFC Bank", "SBI", "Axis Bank", "ICICI"], answer: "HDFC Bank" }
        ];

        // --- STATE MANAGEMENT ---
        let studentInfo = {};
        let currentQuestionIndex = 0;
        let studentResponses = Array(quizQuestions.length).fill(null);
        let timerInterval;
        // Time per question is 10 seconds
        const TIME_PER_QUESTION = 10; 
        let timeLeft = TIME_PER_QUESTION;
        
        // Check localStorage for quiz status, default to true
        let isQuizActive = localStorage.getItem('isQuizActive') === 'false' ? false : true; 
        
        // Updated violation structure for granular tracking
        let proctoringViolations = {
            total: 0,
            windowSwitch: 0,
            copyPaste: 0
        };
        const MAX_VIOLATIONS = 3; // Max total violations before ending exam
        
        // Debounce mechanism to prevent multiple window-switch counts
        let violationCooldown = false; 
        const COOLDOWN_DURATION = 2000; // 2 seconds cooldown

        const APP_CONTAINER = document.getElementById('app');
        const ADMIN_BUTTON = document.getElementById('adminButton');
        const VIOLATION_MODAL = document.getElementById('violationModal');
        const MODAL_CONFIRM_BTN = document.getElementById('modalConfirmBtn');
        const VIOLATION_MESSAGE = document.getElementById('violationMessage');
        const QUIZ_OFF_MODAL = document.getElementById('quizOffModal');
        const QUIZ_OFF_CONFIRM_BTN = document.getElementById('quizOffConfirmBtn');

        // --- HELPER FUNCTIONS ---

        // Manages view switching
        function setView(viewName) {
            // Hide all custom modals when switching views
            VIOLATION_MODAL.style.display = 'none';
            QUIZ_OFF_MODAL.style.display = 'none'; 
            
            // Ensure the sign-in form is visible before rendering it
            const signInForm = document.getElementById('signInForm');
            if(signInForm) signInForm.style.display = 'block'; 

            ADMIN_BUTTON.style.display = (viewName === 'quiz') ? 'none' : 'block';
            APP_CONTAINER.innerHTML = '';
            if (viewName === 'signin') renderSignIn();
            else if (viewName === 'quiz') renderQuiz();
            else if (viewName === 'results') renderResults();
            else if (viewName === 'admin') renderAdminLogin();
            else if (viewName === 'leaderboard') renderLeaderboard();
        }

        // Utility to show a temporary message (since we can't use alert)
        function showTempMessage(msg) {
            let tempDiv = document.getElementById('tempMessage');
            if (!tempDiv) {
                tempDiv = document.createElement('div');
                tempDiv.id = 'tempMessage';
                tempDiv.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-lg shadow-xl z-[60] opacity-0 transition-opacity duration-300';
                document.body.appendChild(tempDiv);
            }
            tempDiv.textContent = msg;
            tempDiv.style.opacity = '1';
            setTimeout(() => { tempDiv.style.opacity = '0'; }, 3000);
        }

        // Retrieves leaderboard data from Local Storage
        function getLeaderboard() {
            try {
                const data = localStorage.getItem('quizLeaderboard');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Error parsing leaderboard from localStorage:", e);
                return [];
            }
        }

        // Saves current student's score to Local Storage (returns the result object for Supabase)
        function saveResult(name, email, admissionNo, score, totalQuestions, violations) {
            const leaderboard = getLeaderboard();
            const result = {
                name: name,
                email: email,
                admissionNo: admissionNo,
                score: score,
                total: totalQuestions,
                percentage: ((score / totalQuestions) * 100).toFixed(2),
                violations: violations.total, 
                windowSwitchViolations: violations.windowSwitch,
                copyPasteViolations: violations.copyPaste,
                timestamp: new Date().toLocaleString()
            };
            leaderboard.push(result);
            // Sort by score (descending) then by time (ascending) to break ties
            leaderboard.sort((a, b) => b.score - a.score || new Date(a.timestamp) - new Date(b.timestamp));
            localStorage.setItem('quizLeaderboard', JSON.stringify(leaderboard));
            return result; // Return the result object for Supabase upload
        }

        // NEW ASYNC FUNCTION: Upload result to Supabase
        async function uploadResultToSupabase(resultData) {
            // FIX: Removed the check that prevented the upload when default credentials were used.
            // WARNING: The actual credentials MUST be configured above for this to connect to your database.
            
            // Structure data for the Supabase table
            const dataToInsert = {
                student_name: resultData.name,
                college_email: resultData.email,
                admission_no: resultData.admissionNo,
                score: resultData.score,
                total_questions: resultData.total,
                percentage: parseFloat(resultData.percentage),
                total_violations: resultData.violations,
                window_switch_violations: resultData.windowSwitchViolations,
                copy_paste_violations: resultData.copyPasteViolations,
                submission_time: new Date().toISOString()
            };

            console.log("Attempting to insert:", dataToInsert);

            try {
                const { error } = await client
                    .from(SUPABASE_TABLE_NAME)
                    .insert([dataToInsert]);

                if (error) {
                    console.error('Error inserting data into Supabase:', error.message);
                    showTempMessage('Database error: Failed to save results. Check console.');
                } else {
                    console.log('Successfully saved results to Supabase.');
                    showTempMessage('Quiz submitted and result saved to database.');
                }
            } catch (e) {
                console.error('Supabase connection error:', e);
                showTempMessage('Connection error: Could not reach database.');
            }
        }

        // Toggle Quiz Status (Admin Feature)
        function toggleQuizState() {
            isQuizActive = !isQuizActive;
            localStorage.setItem('isQuizActive', isQuizActive);
            renderLeaderboard();
        }
        
        // Show Quiz Off Modal
        function showQuizOffModal() {
            const signInForm = document.getElementById('signInForm');
            if (signInForm) signInForm.style.display = 'none'; 
            
            QUIZ_OFF_MODAL.style.display = 'flex';
            
            // Set up button to dismiss modal and re-show the sign-in form
            QUIZ_OFF_CONFIRM_BTN.onclick = () => {
                QUIZ_OFF_MODAL.style.display = 'none';
                if(signInForm) setView('signin'); // Reload signin view to refresh state
            };
        }


        // --- PROCTORING LOGIC (Unchanged) ---

        // Request Full Screen
        function requestFullScreen() {
            const element = document.documentElement;
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) {
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }

        // Exit Full Screen
        function exitFullScreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }
        
        // Show custom modal instead of alert
        function showViolationModal(isTerminating) {
            if (isTerminating) {
                VIOLATION_MESSAGE.innerHTML = `
                    <p class="text-red-700 font-semibold">FINAL WARNING: ${MAX_VIOLATIONS} violations detected.</p> 
                    <p>The exam has been terminated. Your score will be recorded with violations.</p>
                `;
                MODAL_CONFIRM_BTN.textContent = 'End Exam';
                MODAL_CONFIRM_BTN.onclick = () => {
                    VIOLATION_MODAL.style.display = 'none';
                    stopTimer();
                    disableProctoring(); 
                    exitFullScreen();
                    calculateAndShowResults(true); 
                };
            } else {
                VIOLATION_MESSAGE.innerHTML = `
                    Do not violate the rules. 
                    <span class="font-bold">Total violations: ${proctoringViolations.total}/${MAX_VIOLATIONS}.</span> 
                    The exam will terminate upon the ${MAX_VIOLATIONS}rd violation.
                `;
                MODAL_CONFIRM_BTN.textContent = 'Return to Quiz';
                MODAL_CONFIRM_BTN.onclick = () => {
                    VIOLATION_MODAL.style.display = 'none';
                    requestFullScreen(); 
                };
            }
            VIOLATION_MODAL.style.display = 'flex';
        }

        // Proctoring violation handler
        function handleProctoringViolation(type) {
            if (currentQuestionIndex >= quizQuestions.length) {
                return; 
            }
            
            if (type === 'windowSwitch') {
                if (violationCooldown) return; 
                
                proctoringViolations.windowSwitch++;
                
                violationCooldown = true;
                setTimeout(() => { violationCooldown = false; }, COOLDOWN_DURATION);

                requestFullScreen(); 
            } 
            else if (type === 'copyPaste') {
                proctoringViolations.copyPaste++;
            } else {
                return; 
            }
            
            proctoringViolations.total++;

            const violationDisplay = document.getElementById('violationCountDisplay');
            if (violationDisplay) {
                violationDisplay.innerHTML = `⚠️ Violations: ${proctoringViolations.total} / ${MAX_VIOLATIONS} (Tab: ${proctoringViolations.windowSwitch}, Copy/Paste: ${proctoringViolations.copyPaste})`;
            }

            if (proctoringViolations.total >= MAX_VIOLATIONS) {
                showViolationModal(true); 
            } else if (type === 'windowSwitch') {
                showViolationModal(false); 
            }
        }
        
        // Named functions for event listeners to allow proper removal

        const visibilityChangeHandler = () => {
            if (document.hidden) {
                handleProctoringViolation('windowSwitch');
            }
        };

        const blurHandler = () => {
            handleProctoringViolation('windowSwitch');
        };

        const copyCutPasteHandler = (e) => {
            e.preventDefault();
            
            const message = e.type === 'paste' ? 'Pasting is blocked during the exam.' : 'Copying/cutting content is blocked during the exam.';
            showTempMessage(message); 
            
            handleProctoringViolation('copyPaste');
        };

        // Attach event listeners for proctoring
        function enableProctoring() {
            document.addEventListener('visibilitychange', visibilityChangeHandler);
            window.addEventListener('blur', blurHandler);
            document.addEventListener('copy', copyCutPasteHandler);
            document.addEventListener('cut', copyCutPasteHandler);
            document.addEventListener('paste', copyCutPasteHandler);
        }

        // Detach event listeners
        function disableProctoring() {
            document.removeEventListener('visibilitychange', visibilityChangeHandler);
            window.removeEventListener('blur', blurHandler);
            document.removeEventListener('copy', copyCutPasteHandler);
            document.removeEventListener('cut', copyCutPasteHandler);
            document.removeEventListener('paste', copyCutPasteHandler);
        }

        // --- QUIZ TIMER & NAVIGATION LOGIC (Unchanged) ---

        function updateTimerDisplay() {
            const progressBar = document.getElementById('progressBar');
            const countdownTimer = document.getElementById('countdownValue'); 
            
            if (progressBar) {
                const percentage = (timeLeft / TIME_PER_QUESTION) * 100;
                progressBar.style.width = percentage + '%';
            }
            if (countdownTimer) {
                countdownTimer.textContent = timeLeft;
            }
        }

        function startTimer() {
            stopTimer();
            timeLeft = TIME_PER_QUESTION;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    stopTimer();
                    studentResponses[currentQuestionIndex] = null;
                    moveToNextQuestion();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function moveToNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                renderQuizQuestion();
                startTimer();
            } else {
                stopTimer();
                disableProctoring();
                exitFullScreen();
                calculateAndShowResults(false);
            }
        }

        // --- QUIZ RENDERING ---

        function renderSignIn() {
            APP_CONTAINER.className = "flex items-center justify-center min-h-screen p-4 bg-gray-50";
            APP_CONTAINER.innerHTML = `
                <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8 transform transition duration-500 hover:shadow-3xl">
                    <h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">Quiz Sign-In</h2>
                    <p class="text-center text-gray-600 mb-8">Enter your details to begin the proctored examination.</p>
                    <form id="signInForm" class="space-y-4">
                        <div>
                            <label for="studentName" class="block text-sm font-medium text-gray-700">Student Name</label>
                            <input type="text" id="studentName" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="collegeEmail" class="block text-sm font-medium text-gray-700">College Email ID</label>
                            <input type="email" id="collegeEmail" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="admissionNo" class="block text-sm font-medium text-gray-700">Admission No.</label>
                            <input type="text" id="admissionNo" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out mt-6">
                            Start Quiz (Activate Proctoring)
                        </button>
                    </form>
                </div>
            `;

            document.getElementById('signInForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // FEATURE CHECK: Block access if quiz is not active
                if (!isQuizActive) {
                    showQuizOffModal();
                    return; 
                }
                
                studentInfo = {
                    name: document.getElementById('studentName').value.trim(),
                    email: document.getElementById('collegeEmail').value.trim(),
                    admissionNo: document.getElementById('admissionNo').value.trim()
                };
                requestFullScreen();
                enableProctoring();
                setView('quiz');
            });
        }

        function renderQuiz() {
            APP_CONTAINER.className = "flex items-start justify-center min-h-screen p-4 bg-gray-100";
            APP_CONTAINER.innerHTML = `
                <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl p-8 mt-10">
                    <h1 class="text-2xl font-bold text-gray-900 mb-4">Proctored Business & Finance Quiz</h1>
                    <div id="progressBarContainer">
                        <div id="progressBar"></div>
                    </div>
                    <div id="countdownTimer">Time Left: <span id="countdownValue">${TIME_PER_QUESTION}</span>s</div> 
                    <div id="quizContent"></div>
                </div>
            `;
            renderQuizQuestion();
            startTimer();
        }

        function renderQuizQuestion() {
            const quizContent = document.getElementById('quizContent');
            const q = quizQuestions[currentQuestionIndex];
            const qNum = currentQuestionIndex + 1;
            const total = quizQuestions.length;

            quizContent.innerHTML = `
                <div class="mb-6">
                    <div class="text-sm font-medium text-blue-600 mb-2">Question ${qNum} of ${total}</div>
                    <h3 class="text-xl font-semibold text-gray-800">${q.question}</h3>
                </div>
                <div class="space-y-4" id="optionsContainer">
                    ${q.options.map((option, index) => `
                        <label class="flex items-center p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-blue-50 transition duration-150">
                            <input type="radio" name="answer" value="${option}" class="form-radio h-5 w-5 text-blue-600" ${studentResponses[currentQuestionIndex] === option ? 'checked' : ''}>
                            <span class="ml-4 text-gray-700">${option}</span>
                        </label>
                    `).join('')}
                </div>
                <div class="flex justify-end mt-8">
                    <button id="nextButton" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out">
                        ${qNum === total ? 'Finish Quiz' : 'Next Question'} <i class="fas ${qNum === total ? 'fa-check' : 'fa-arrow-right'} ml-2"></i>
                    </button>
                </div>
                ${proctoringViolations.total > 0 ? `<p id="violationCountDisplay" class="mt-4 text-sm text-red-600 font-medium text-right">⚠️ Violations: ${proctoringViolations.total} / ${MAX_VIOLATIONS} (Tab: ${proctoringViolations.windowSwitch}, Copy/Paste: ${proctoringViolations.copyPaste})</p>` : `<p id="violationCountDisplay" class="mt-4 text-sm text-gray-500 font-medium text-right">No violations recorded.</p>`}
            `;

            document.getElementById('nextButton').addEventListener('click', () => {
                const selected = document.querySelector('input[name="answer"]:checked');
                // Record the response 
                studentResponses[currentQuestionIndex] = selected ? selected.value : null;
                stopTimer();
                moveToNextQuestion();
            });

            // Listen for option selection to record early answer
            document.getElementById('optionsContainer').addEventListener('change', (e) => {
                if (e.target.name === 'answer') {
                    studentResponses[currentQuestionIndex] = e.target.value;
                }
            });
        }

        function calculateAndShowResults(wasTerminated) {
            let score = 0;
            quizQuestions.forEach((q, index) => {
                if (studentResponses[index] === q.answer) {
                    score++;
                }
            });

            // 1. Save results locally (for Admin Leaderboard view)
            const result = saveResult(
                studentInfo.name, 
                studentInfo.email, 
                studentInfo.admissionNo, 
                score, 
                quizQuestions.length, 
                proctoringViolations
            );

            // 2. Upload results to Supabase (asynchronously)
            uploadResultToSupabase(result);
            
            APP_CONTAINER.className = "flex items-center justify-center min-h-screen p-4 bg-gray-50";
            APP_CONTAINER.innerHTML = `
                <div class="w-full max-w-lg bg-white rounded-2xl shadow-2xl p-10 text-center transform transition duration-500">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-6">
                        <i class="fas fa-check-circle text-3xl text-green-600"></i>
                    </div>
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-3">${wasTerminated ? 'Exam Terminated & Submitted' : 'Quiz Submitted Successfully!'}</h2>
                    <p class="text-gray-600 mb-8">${wasTerminated ? `Due to ${proctoringViolations.total} violations, the exam ended forcefully.` : 'Your responses have been recorded.'}</p>
                    
                    <div class="bg-blue-50 p-6 rounded-xl mb-8">
                        <h3 class="text-xl font-bold text-blue-800 mb-3">Your Result</h3>
                        <div class="flex justify-between items-center text-lg text-gray-800 border-b pb-2 mb-2">
                            <span>Score:</span>
                            <span class="font-bold text-green-700">${score} / ${quizQuestions.length}</span>
                        </div>
                        <div class="flex justify-between items-center text-lg text-gray-800">
                            <span>Proctoring Violations (Total):</span>
                            <span class="font-bold text-red-700">${proctoringViolations.total}</span>
                        </div>
                        <div class="flex justify-between items-center text-md text-gray-700 mt-2 pt-2 border-t border-gray-200">
                            <span>- Tab/Window Switch:</span>
                            <span class="font-semibold text-red-600">${proctoringViolations.windowSwitch}</span>
                        </div>
                        <div class="flex justify-between items-center text-md text-gray-700">
                            <span>- Copy/Paste Attempt:</span>
                            <span class="font-semibold text-red-600">${proctoringViolations.copyPaste}</span>
                        </div>
                    </div>

                    <button onclick="setView('signin')" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Return to Sign-In
                    </button>
                </div>
            `;
        }

        // --- ADMIN / LEADERBOARD (Includes Toggle Button) ---

        function renderAdminLogin() {
            APP_CONTAINER.className = "flex items-center justify-center min-h-screen p-4 bg-gray-50";
            APP_CONTAINER.innerHTML = `
                <div class="w-full max-w-sm bg-white rounded-xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-center text-gray-900"><i class="fas fa-user-shield mr-2 text-red-600"></i>Admin Login</h2>
                    <p class="text-center text-gray-500 text-sm mb-4"></p>
                    <form id="adminLoginForm" class="space-y-4">
                        <div>
                            <label for="adminId" class="block text-sm font-medium text-gray-700">Admin ID</label>
                            <input type="text" id="adminId" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="adminPassword" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="adminPassword" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out mt-6">
                            Login
                        </button>
                        <button type="button" onclick="setView('signin')" class="w-full mt-2 py-2 px-4 rounded-lg text-sm font-medium text-gray-600 border border-gray-300 hover:bg-gray-100 transition duration-150 ease-in-out">
                            Back to Home
                        </button>
                    </form>
                </div>
            `;

            document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('adminId').value;
                const password = document.getElementById('adminPassword').value;

                if (id === 'admin' && password === 'admin123') { 
                    setView('leaderboard');
                } else {
                    const loginMessage = document.createElement('p');
                    loginMessage.className = 'text-sm text-red-500 mt-2 text-center';
                    loginMessage.textContent = 'Invalid Admin ID or Password.';
                    document.getElementById('adminLoginForm').appendChild(loginMessage);
                    setTimeout(() => loginMessage.remove(), 3000);
                }
            });
        }

        function renderLeaderboard() {
            const leaderboard = getLeaderboard();
            APP_CONTAINER.className = "flex items-start justify-center min-h-screen p-4 bg-gray-100";
            
            const tableRows = leaderboard.map((entry, index) => `
                <tr class="hover:bg-gray-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.admissionNo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-700">${entry.score}/${entry.total}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${entry.percentage >= 80 ? 'text-green-600' : entry.percentage >= 50 ? 'text-yellow-600' : 'text-red-600'}">${entry.percentage}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-500">${entry.violations} (W:${entry.windowSwitchViolations || 0}, C:${entry.copyPasteViolations || 0})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.timestamp}</td>
                </tr>
            `).join('');
            
            const tableContent = tableRows.length > 0 ? tableRows : `<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500 font-medium bg-white">No results recorded yet.</td></tr>`;

            APP_CONTAINER.innerHTML = `
                <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl p-8 mt-10">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900"><i class="fas fa-trophy mr-2 text-yellow-500"></i>Real-Time Leaderboard</h2>
                        <div class="flex items-center space-x-4">
                            <button id="quizToggleButton" class="px-4 py-2 rounded-lg text-sm font-medium text-white ${isQuizActive ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} transition duration-150">
                                <i class="fas ${isQuizActive ? 'fa-toggle-on' : 'fa-toggle-off'} mr-2"></i>Quiz Status: ${isQuizActive ? 'ON' : 'OFF'}
                            </button>
                            <button onclick="setView('signin')" class="px-4 py-2 rounded-lg text-sm font-medium text-blue-600 border border-blue-600 hover:bg-blue-50 transition duration-150">
                                Return Home
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto shadow border-b border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admission No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Violations (W/C)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${tableContent}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('quizToggleButton').addEventListener('click', toggleQuizState);
        }


        // --- INITIALIZATION (Unchanged) ---
        document.addEventListener('DOMContentLoaded', () => {
            setView('signin');
            
            // Handle Admin Button Click
            ADMIN_BUTTON.addEventListener('click', () => {
                setView('admin'); // Always go to admin login screen
            });

            // Full-screen change handler function 
            const fullScreenChangeHandler = () => {
                if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && currentQuestionIndex < quizQuestions.length && VIOLATION_MODAL.style.display !== 'flex') {
                    handleProctoringViolation('windowSwitch'); 
                }
            };

            // Attach full-screen handlers
            document.addEventListener('fullscreenchange', fullScreenChangeHandler);
            document.addEventListener('webkitfullscreenchange', fullScreenChangeHandler);
            document.addEventListener('mozfullscreenchange', fullScreenChangeHandler);
        });
    </script>
</body>
</html>
